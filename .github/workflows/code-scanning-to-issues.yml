name: Code Scanning â†’ GitHub Issues

# Triggers after CodeQL analysis completes on main branch.
# Previously used `code_scanning_alert` event, which caused phantom failures
# on every push because GitHub Actions validates all workflow files at push time
# but cannot process webhook-only events during validation.

on:
  workflow_run:
    workflows: ['CodeQL']
    types: [completed]
    branches: [main]

permissions:
  issues: write
  security-events: read
  actions: read

jobs:
  create-issues:
    name: Create issues for new alerts
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Fetch alerts and create issues
        uses: actions/github-script@v7
        with:
          script: |
            // Fetch open code scanning alerts for the default branch
            let alerts;
            try {
              const resp = await github.rest.codeScanning.listAlertsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                ref: 'refs/heads/main',
                per_page: 100,
              });
              alerts = resp.data;
            } catch (error) {
              if (error.status === 404) {
                core.info('Code scanning not enabled or no alerts found.');
                return;
              }
              throw error;
            }

            if (alerts.length === 0) {
              core.info('No open code scanning alerts.');
              return;
            }

            // Fetch existing open issues with 'codeql' label for deduplication
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'codeql',
              per_page: 100,
            });
            const existingTitles = new Set(existing.data.map(i => i.title));

            let created = 0;
            for (const alert of alerts) {
              const rule = alert.rule;
              const inst = alert.most_recent_instance;
              const loc = inst.location;

              const severityEmoji = {
                critical: 'ğŸ”´',
                high:     'ğŸŸ ',
                medium:   'ğŸŸ¡',
                low:      'ğŸ”µ',
                note:     'âšª',
                warning:  'ğŸŸ¡',
              }[rule.severity] ?? 'âšª';

              const lineRef = loc.end_line && loc.end_line !== loc.start_line
                ? `${loc.start_line}-${loc.end_line}`
                : `${loc.start_line}`;

              const title = `[CodeQL] ${severityEmoji} ${rule.description} â€” ${loc.path}:${lineRef}`;

              if (existingTitles.has(title)) {
                core.info(`Issue already exists: ${title}`);
                continue;
              }

              const body = [
                `## ${severityEmoji} Code Scanning Alert`,
                '',
                `| í•­ëª© | ê°’ |`,
                `|------|-----|`,
                `| **Rule** | \`${rule.id}\` |`,
                `| **Severity** | \`${rule.severity}\` |`,
                `| **File** | \`${loc.path}\` (line ${lineRef}) |`,
                `| **State** | \`${alert.state}\` |`,
                `| **Alert URL** | [#${alert.number}](${alert.html_url}) |`,
                '',
                `### ì„¤ëª…`,
                rule.full_description || rule.description,
                '',
                `### ì¬í˜„ ìœ„ì¹˜`,
                '```',
                `${loc.path}:${lineRef}`,
                '```',
                '',
                `> ì´ ì´ìŠˆëŠ” CodeQL ì½”ë“œ ìŠ¤ìºë‹ ê²°ê³¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                `> í•´ë‹¹ [CodeQL alert](${alert.html_url})ë¥¼ ì§ì ‘ í™•ì¸í•˜ë ¤ë©´ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.`,
              ].join('\n');

              const labels = ['security', 'codeql'];
              if (['critical', 'high'].includes(rule.severity)) {
                labels.push('priority: high');
              }

              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels,
              });

              existingTitles.add(title);
              created++;
              core.notice(`Created issue #${issue.number}: ${issue.html_url}`);
            }

            core.info(`Done. Created ${created} new issue(s) from ${alerts.length} open alert(s).`);
