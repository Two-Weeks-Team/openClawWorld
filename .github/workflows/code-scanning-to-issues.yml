name: Code Scanning â†’ GitHub Issues

# Triggers when CodeQL finds a new alert or an existing alert appears in a branch.
# Note: actionlint may warn about 'code_scanning_alert' â€” this is a known false positive
# as actionlint's event database does not yet include this valid GitHub webhook event.
# See: https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#code_scanning_alert

on:
  code_scanning_alert:
    types: [created, appeared_in_branch]

permissions:
  issues: write
  security-events: read

jobs:
  create-issue:
    name: Create issue for alert
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const alert = context.payload.alert;
            const rule   = alert.rule;
            const inst   = alert.most_recent_instance;
            const loc    = inst.location;

            const severityEmoji = {
              critical: 'ğŸ”´',
              high:     'ğŸŸ ',
              medium:   'ğŸŸ¡',
              low:      'ğŸ”µ',
              note:     'âšª',
              warning:  'ğŸŸ¡',
            }[rule.severity] ?? 'âšª';

            const lineRef = loc.end_line && loc.end_line !== loc.start_line
              ? `${loc.start_line}-${loc.end_line}`
              : `${loc.start_line}`;

            const title = `[CodeQL] ${severityEmoji} ${rule.description} â€” ${loc.path}:${lineRef}`;

            // Skip if an issue with this exact title already exists (de-duplicate)
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              state: 'open',
              labels: 'codeql',
              per_page: 100,
            });
            if (existing.data.some(i => i.title === title)) {
              core.info(`Issue already exists for: ${title}`);
              return;
            }

            const body = [
              `## ${severityEmoji} Code Scanning Alert`,
              '',
              `| í•­ëª© | ê°’ |`,
              `|------|-----|`,
              `| **Rule** | \`${rule.id}\` |`,
              `| **Severity** | \`${rule.severity}\` |`,
              `| **File** | \`${loc.path}\` (line ${lineRef}) |`,
              `| **State** | \`${alert.state}\` |`,
              `| **Alert URL** | [#${alert.number}](${alert.html_url}) |`,
              '',
              `### ì„¤ëª…`,
              rule.full_description || rule.description,
              '',
              `### ì¬í˜„ ìœ„ì¹˜`,
              '```',
              `${loc.path}:${lineRef}`,
              '```',
              '',
              `> ì´ ì´ìŠˆëŠ” CodeQL ì½”ë“œ ìŠ¤ìºë‹ ê²°ê³¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`,
              `> í•´ë‹¹ [CodeQL alert](${alert.html_url})ë¥¼ ì§ì ‘ í™•ì¸í•˜ë ¤ë©´ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.`,
            ].join('\n');

            const labels = ['security', 'codeql'];
            if (['critical', 'high'].includes(rule.severity)) {
              labels.push('priority: high');
            }

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              title,
              body,
              labels,
            });

            core.notice(`Created issue #${issue.number}: ${issue.html_url}`);
